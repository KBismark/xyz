const fs = require("fs");
const parse = require("./parse").parseModules;
const path = require("path");
let slash = path.join("/");
let base = path.join(__dirname).split(slash);
base = base.slice(0,base.length-3).join(slash)//Pops base directory leaving out node_modules/import-for-web/lib
let dependencyMap, dependentsMap;
let visted = {};

function Concantenate(source, dependencies) {
    if (!visted[source]) {
        visted[source] = 1;
    } else {
        return;
    }
    let file,dependents,adders=[];
    for (let i = 0; i < dependencies.length; i++){
        file = dependencies[i]
        if (dependents = dependentsMap[file]) {
            if (dependents.length == 1) {
                adders.push(file)
            }
            Concantenate(file, dependencyMap[file] || []);
        }
    }
    let actualSrc = source;
    fs.writeFileSync((source = source + '.i4w.js'), '');
    for (let i = 0; i < adders.length; i++){
        fs.appendFileSync(source, fs.readFileSync(adders[i] + '.i4w.js'))
        fs.appendFileSync(source,"\n")
    }
    fs.appendFileSync(source, fs.readFileSync(actualSrc));
}




module.exports = function () {
    parse();
    const depMap = require(base + "/import-bundle-map.js");
    dependencyMap = depMap.dependencyMap;
    dependentsMap = depMap.dependentsMap;
    visted = {};
    for (let file in dependencyMap) {
        Concantenate(file,dependencyMap[file])
    }
}